- name: Add Docker GPG apt Key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present

- name: Add Docker Repository
  apt_repository:
    repo: deb https://download.docker.com/linux/ubuntu {{ ansible_facts.lsb.codename }} stable
    state: present

- name: Install latest docker and requirements
  apt: name={{item}}
  with_items:
    - docker-ce
    - docker-ce-cli
    - containerd.io
    - docker-buildx-plugin
    - docker-compose-plugin

- name: Install Docker Module for Python
  pip:
    name: docker

- name: check docker is active
  service:
    name: docker
    state: started
    enabled: yes

- name: Make sure docker group exists
  ansible.builtin.group:
    name: docker
    state: present

- name: Check if username_on_the_host is root, if yes then exit
  ansible.builtin.fail: msg="Exiting, need to be non-root for this to work. Try run without sudo"
  when: username_on_the_host.stdout == "root"

- name: Adding user to docker group
  user:
    name: "{{ username_on_the_host.stdout }}"
    groups: docker
    append: yes
  register: add_user_result

- name: Verify user is in docker group
  become: false
  command: groups {{ username_on_the_host.stdout }}
  register: user_groups
  changed_when: false

- name: Check docker group membership
  ansible.builtin.debug:
    msg: "User groups: {{ user_groups.stdout }}"

- name: Create helper script to activate docker group
  become: false
  copy:
    content: |
      #!/bin/bash
      echo "Activating docker group membership..."
      exec newgrp docker
    dest: /tmp/activate-docker-group.sh
    mode: '0755'
  when: add_user_result.changed == True

- name: Notify user about group change
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "WARNING: User {{ username_on_the_host.stdout }} has been added to the docker group."
      - "To use docker without sudo, run this command now:"
      - ""
      - "    newgrp docker"
      - ""
      - "Or run the helper script: source /tmp/activate-docker-group.sh"
      - "Or alternatively: log out/in or reboot"
      - "=========================================="
  when: add_user_result.changed == True
